/* funnel-relay version 2.5.27  - do the magic here 2020-06-24 11:11 */
trx=window.trx||{},function(){"use strict";trx.MagicLinks=class{static prepareDefaultSettings(e){return"object"!=typeof e.detection_rules&&(e.detection_rules={auto:!0,custom:[],exclude_urls:[],page_url_filter:""}),null==e.detection_rules.auto&&(e.detection_rules.auto=!0),null==e.detection_rules.auto_networks&&(e.detection_rules.auto_networks={amazon:!1,ls:!0,cj:!0,sas:!1,awin:!1,pj:!1,sl:!1,vl:!1,ir:!1,td:!1,wg:!1,pt:!1,al:!1,at:!1,tt:!1,dynamic:!1}),e.detection_rules.custom instanceof Array||(e.detection_rules.custom=[]),e.detection_rules.exclude_urls instanceof Array||(e.detection_rules.exclude_urls=[]),null==e.detection_rules.page_url_filter&&(e.detection_rules.page_url_filter=""),null==e.detection_rules.amazon_no_append&&(e.detection_rules.amazon_no_append=!1),"object"!=typeof e.features&&(e.features={}),null==e.features.append_referrer&&(e.features.append_referrer={enabled:!0,attr_name:"referrer",new_query_param:!1}),null==e.features.attributes_forwarding&&(e.features.attributes_forwarding={enabled:!1,attributes:[]}),null==e.features.append_timing&&(e.features.append_timing={enabled:!1,t_load:!1,t_clicked:!1,t_toclick:!1,new_query_param:!1}),null==e.features.append_attributes&&(e.features.append_attributes={enabled:!1,attributes:""}),null==e.features.track_events&&(e.features.track_events={enabled:!1,pageview:!1,clicks:!1,props_map:{xid:"prop1",link:"prop2",label:"prop3",referrer:"prop4",origin:"prop5"},props_map_custom:[]}),null==e.features.auto_optimize_link&&(e.features.auto_optimize_link={enabled:!1}),null==e.features.link_preview&&(e.features.link_preview={enabled:!1,show_icon:!1,show_metadata:!1,show_coupons:!1}),null==e.features.shorten_extra_param&&(e.features.shorten_extra_param={enabled:!1}),null==e.features.metadata&&(e.features.metadata={enabled:!1,selectors:""}),null==e.features.spot&&(e.features.spot={enabled:!1,link_rules:!0,page_rules:!1,banner_rules:!1,text_rules:!1,link_offers:!0,page_offers:!1,banner_offers:!1,text_offers:!1}),null==e.features.srs&&(e.features.srs={enabled:!1}),e}constructor(e){try{null==e&&(e=!0),null==t&&(t="prod"),this._paramsBuffer={attr_forwarding:{},metadata:{},timing:{},urls:{},attr_append:{},page_trace:[]},this._autoRun=e,this.init(e)}catch(e){this._error(e,e.stack)}}init(){try{if(this._onPageSettings=trx.magic_links_settings||{},this._envSettings={"events_recording_env":"discovery","events_recording_api":"https://2uiyya80pg.execute-api.us-east-1.amazonaws.com/Prod","app_key":"gsd65fgr0hgTTT"},this._serverSettings={"detection_rules":{"auto":"true","page_url_filter":"","auto_networks":{"amazon":"false","awin":"true","cj":"true","ir":"true","ls":"true","sas":"true","sl":"true","vg":"true","pj":"true","td":"true","wg":"true","pt":"true","al":"false","at":"false","tt":"false","dynamic":"true"},"amazon_no_append":"false"},"features":{"append_referrer":{"enabled":"true","attr_name":"referrer"},"attributes_forwarding":{"enabled":"true","attributes":["nl","c1","c2","soc","syc","xp","source","medium","campaign","content"]},"append_timing":{"enabled":"false","t_load":"false","t_clicked":"false","t_toclick":"false"},"append_attributes":{"enabled":"false","attributes":""},"track_events":{"enabled":"true","pageview":"false","clicks":"false","props_map":{"xid":"prop1","link":"prop2","label":"prop3","referrer":"prop4","origin":"prop5"},"analytics_code":""},"link_preview":{"enabled":"false","show_icon":"false","show_metadata":"false","show_coupons":"false"},"metadata":{"enabled":"true","selectors":"PageUniqueID | js::mdManager.getParameter('UniqueID')\nPageTitle | js::mdManager.getParameter('Title')\nPublicationDate | js::mdManager.getParameter('OrigPubDate')\nPageType | js::mdManager.getParameter('Type')\nCategoryDspName | js::mdManager.getParameter('CategoryDspName')\nPageName | js::mdManager.getParameter('Url')\nTags | js::var tt='';document.getElementsByClassName('o-Tags')[0].querySelectorAll('a.a-Tag').forEach(function(node) {tt+=node.innerHTML+',';});tt.substring(0, tt.length - 1);"},"spot":{"enabled":"false","link_rules":"true","page_rules":"false","banner_rules":"false","text_rules":"false","link_offers":"true","page_offers":"false","banner_offers":"false","text_offers":"false","profile":"discovery_gjS38Lk6t","asin_rules":"false"},"srs":{"enabled":"false","srs":{"enabled":"false"}}},"disable_rules":{"enabled":"false"},"impact_domains":{"2cw9.net":1,"w6fg.net":1,"7ymy.net":1,"zz6n.net":1,"a4v3ci.net":1,"dttq.net":1,"5oih.net":1,"njih.net":1,"rfvk.net":1,"rt8x.net":1,"43k8.net":1,"7eer.net":1,"uzvs.net":1,"u44t.net":1,"pvxt.net":1,"vaz6fn.net":1,"ojrq.net":1,"mvvx.net":1,"yx69dc.net":1,"awb5.net":1,"k7qtpo.net":1,"8odi.net":1,"mp5l.net":1,"evyy.net":1,"fx3vf7.net":1,"2npn3e.net":1,"i9pljp.net":1,"l9vx.net":1,"75r4.net":1,"ulnv.net":1,"74rjtv.net":1,"trw6mw.net":1,"xwrk.net":1,"dgdrgu.net":1,"tnu8.net":1,"pq2o.net":1,"snlv.net":1,"yfb7.net":1,"vzck.net":1,"glg9ob.net":1,"5f77.net":1,"sk2bvq.net":1,"iln8.net":1,"7tiv.net":1,"o93x.net":1,"yfh6ag.net":1,"zfrcsk.net":1,"kwpkyy.net":1,"6cqhdo.net":1,"fziv.net":1,"f9tmep.net":1,"bwa8.net":1,"74az.net":1,"gnv2.net":1,"uidg.net":1,"i3zp.net":1,"ssxmnr.net":1,"l9yg.net":1,"ixmz.net":1,"fmtgqt.net":1,"uydo.net":1,"2lsp.net":1,"oie8.net":1,"7mh5.net":1,"tmfhgn.net":1,"ngi2ba.net":1,"bs6l.net":1,"fdf2.net":1,"ruqo.net":1,"bts6.net":1,"yxku6p.net":1,"xhuc.net":1,"b9i7.net":1,"vzffua.net":1,"oteh.net":1,"uskn.net":1,"kxyi.net":1,"hyyc7q.net":1,"5ad6.net":1,"n76h.net":1,"quvl.net":1,"qflm.net":1,"8hwt.net":1,"ig9i.net":1,"d2lsjo.net":1,"9quv.net":1,"rao4.net":1,"xikq.net":1,"72mu89.net":1,"xrx2ci.net":1,"q4ew.net":1,"j4ib.net":1,"wrrv.net":1,"uqzq.net":1,"mw46.net":1,"z6vo.net":1,"g39l.net":1,"2det.net":1,"ibfwsl.net":1,"jtlo.net":1,"dfjeo3.net":1,"wqi6.net":1,"jgpt48.net":1,"eccsr4.net":1,"myi4.net":1,"j4df.net":1,"s7so.net":1,"w2wxmz.net":1,"64ud.net":1,"6rfywi.net":1,"rrmo.net":1,"2m8f.net":1,"fu4n.net":1,"ryvx.net":1,"mjs4.net":1,"bn5x.net":1,"7xde.net":1,"5vju.net":1,"7zd4df.net":1,"xuok.net":1,"o64jx9.net":1,"am3t9s.net":1,"w2t6.net":1,"xr64.net":1,"vayb.net":1,"ygwk.net":1,"ioym.net":1,"dg6u.net":1,"oyuv.net":1,"otg8.net":1,"8ujrgu.net":1,"3qag.net":1,"3f64ir.net":1,"hrlo.net":1,"fjbu.net":1,"fqik.net":1,"43wo.net":1,"ncw6.net":1,"9nz77o.net":1,"xk3g.net":1,"p7qb.net":1,"mvqw.net":1,"ntaf.net":1,"iypa.net":1,"rv5k.net":1,"wjx7.net":1,"5d3x.net":1,"saq2.net":1,"vegb.net":1,"pxi6.net":1,"b54k.net":1,"njv3dp.net":1,"nob9.net":1,"t8puue.net":1,"briy.net":1,"bpu9.net":1,"voq9.net":1,"8aog.net":1,"dodxnr.net":1,"igs4ds.net":1,"w9v5.net":1,"exgl.net":1,"3uu8.net":1,"ei7w.net":1,"vjggsg.net":1,"79ic8e.net":1,"6noy.net":1,"zrjdwn.net":1,"vdcy.net":1,"8ne3.net":1,"tk2x2c.net":1,"2xc8.net":1,"3tvl.net":1,"tkjf.net":1,"r69o.net":1,"o5kg.net":1,"74wq.net":1,"zc5a.net":1,"e8i7.net":1,"bvrd.net":1,"r2oa.net":1,"uisv.net":1,"uqhv.net":1,"y8uw.net":1,"o67m.net":1,"ydow.net":1,"mlvy.net":1,"liln.net":1,"ga3c.net":1,"szey.net":1,"2lka.net":1,"opfm.net":1,"rhq9ml.net":1,"jvam.net":1,"uqog.net":1,"ork2.net":1,"nwh3qn.net":1,"znqymu.net":1,"wsslc4.net":1,"8kt6.net":1,"9pctbx.net":1,"7voo.net":1,"ifmu.net":1,"fzsu.net":1,"9j4c.net":1,"ow29pp.net":1,"sgur.net":1,"icjj.net":1,"27exom.net":1,"6ywx.net":1,"upvt.net":1,"4paxeq.net":1,"ue8cqz.net":1,"2su64p.net":1,"wo8g.net":1,"lvuv.net":1,"36c4.net":1,"vzew.net":1,"hmqldu.net":1,"m768hc.net":1,"7no9.net":1,"xuvt.net":1,"pfm4.net":1,"3lki.net":1,"p73z.net":1,"i3f2.net":1,"7isk.net":1,"7z5k.net":1,"brvi.net":1,"fi2z.net":1,"znvt.net":1,"tpeipe.net":1,"imlz.net":1,"audw.net":1,"rqu9.net":1,"hjef.net":1,"ln72.net":1,"a5fp.net":1,"juo2.net":1,"ir2by2.net":1,"tf77py.net":1,"eszb.net":1,"2gib.net":1,"bop8.net":1,"nsji.net":1,"mpye.net":1,"hs9x.net":1,"vocq.net":1,"msafflnk.net":1,"8zwg.net":1,"58dp.net":1,"973t.net":1,"hu6f.net":1,"5kd8.net":1,"ue7a.net":1,"i8h2.net":1,"7orgeq.net":1,"mp4l.net":1,"6wfgdb.net":1,"ayxtyv.net":1,"h4km.net":1,"mxu9.net":1,"w9iork.net":1,"ftcv.net":1,"6eld.net":1,"atkw.net":1,"nkwcmr.net":1,"vwz6.net":1,"xovt.net":1,"lkze4s.net":1,"uxsi.net":1,"wkq9.net":1,"8utb.net":1,"2j9x.net":1,"kk2kau.net":1,"iy7a.net":1,"2xje.net":1,"vqi8.net":1,"keof.net":1,"givvml.net":1,"x57o.net":1,"33qw.net":1,"nbq93e.net":1,"tlir.net":1,"7st3op.net":1,"l3km.net":1,"pb6g.net":1,"hj2i.net":1,"8f6i.net":1,"tql5.net":1,"otpb.net":1,"2gfm.net":1,"whij.net":1,"9zpg.net":1,"8mz3uu.net":1,"8hslpj.net":1,"nrku7u.net":1,"xg6r.net":1,"jyae.net":1,"o3ae.net":1,"9vn7kv.net":1,"rw9xb6.net":1,"z5dw.net":1,"wk5q.net":1,"e9jo.net":1,"r7kg.net":1,"uikc.net":1,"258o.net":1,"eyip.net":1,"c9ftyd.net":1,"a9yw.net":1,"krg4.net":1,"et7l.net":1,"wd2f.net":1,"nvaz.net":1,"ozkewk.net":1,"5sfo.net":1,"qumg.net":1,"5l5h.net":1,"cwv7.net":1,"qbt4.net":1,"ytuz.net":1,"3xvk.net":1,"zlyuo6.net":1,"58mq.net":1,"z27l.net":1,"iqoc.net":1,"eqjw.net":1,"dbapeb.net":1,"hgphc2.net":1,"wnbi.net":1,"te8rfv.net":1,"qyiv3c.net":1,"jv6k.net":1,"9rwv.net":1,"zgkv.net":1,"p5ld.net":1,"s4lle7.net":1,"eqcm.net":1,"wsktbf.net":1,"7ema.net":1,"2rch.net":1,"y6mxrg.net":1,"cmuw.net":1,"jedg.net":1,"wmempi.net":1,"lmwjx3.net":1,"zpn8dk.net":1,"z724.net":1,"zihf.net":1,"i5md.net":1,"yaub.net":1,"syuh.net":1,"htuy.net":1,"pbj2.net":1,"zvq6.net":1,"rg35.net":1,"8ibi.net":1,"kbp968.net":1,"5zd6.net":1,"n72aat.net":1,"aiy7.net":1,"nnh2.net":1,"z6rjha.net":1,"7fdy.net":1,"8bvm.net":1,"qodh.net":1,"jwpdsd.net":1,"otegtm.net":1,"2t23.net":1,"i5em.net":1,"xibx.net":1,"xlwzq3.net":1,"deg5.net":1,"3anx.net":1,"78cfvm.net":1,"57ib.net":1,"6dny.net":1,"auhm.net":1,"tm7566.net":1,"tm7516.net":1,"tm7569.net":1,"tm7559.net":1,"tm7560.net":1,"tm7562.net":1,"tm8534.net":1,"lusg.net":1,"bxvfun.net":1,"8bga.net":1,"22o6.net":1,"ebml.net":1,"9q66.net":1,"i679.net":1,"attfm2.net":1,"ztk5.net":1,"dubn.net":1,"yuxg.net":1,"2nm686.net":1,"meqk.net":1,"kd4a.net":1,"e2rq.net":1,"m43q4j.net":1,"hblm3c.net":1,"yvzx.net":1,"vp6l.net":1,"u97e.net":1,"5rmr.net":1,"qyov.net":1,"yoxl.net":1,"e54b.net":1,"akum7z.net":1,"hg7mxc.net":1,"pdy5.net":1,"aqpq.net":1,"mivh.net":1,"eqwh.net":1,"vx83.net":1,"vtdix3.net":1,"xvtl.net":1,"ulvh.net":1,"cw3o.net":1,"zvcr.net":1,"eat8mo.net":1,"ikkr9x.net":1,"6x7g.net":1,"bzi2vw.net":1,"43a8.net":1,"gfpv.net":1,"sjv.io":1,"pxf.io":1,"affiliates.abebooks.com":1,"go.corsair.com":1,"go.gemvara.com":1,"go.jewelry.com":1,"go.web.plus.espn.com":1,"goto.bodybuilding.com":1,"goto.carters.com":1,"goto.grocery.walmart.com":1,"goto.kayosports.com.au":1,"goto.target.com":1,"goto.walmart.com":1,"hpn.houzz.com":1,"linkto.hrblock.com":1,"partners.alamo.com":1,"partners.enterprise.com":1,"partners.hostgator.com":1,"partners.hotwire.com":1,"partners.nationalcar.com":1,"refer.turo.com":1,"tracking.maxcdn.com":1,"tracking.stackpath.com":1,"hpn.houzz.co.uk":1,"partners.wantable.co":1}},null==this._envSettings.events_recording_env&&(this._envSettings.events_recording_env="prod"),this._embedUrlToken="FR-EMBEDDED-RF",this._delimiter1="|",this._delimiter2="~",this._delimiter3="%40%40",this._logPrefix="FunnelRelay:: ",this._loadTime=Date.now(),this._links=[],this._customLinks=new Map,this._report={},this._exclude_urls_regex=[],this._scriptEm=document.getElementById("funnel-relay-installer"),null==this._scriptEm)return void this._error('Installation script is missing  id="funnel-relay-installer" attribute. Funnel Relay will not run');void 0!==trx.amp_redirect&&1==trx.amp_redirect?this.ampRedirectNow():(this._prepareSettings(),this._prepareExcludeRegExp(),this._autoRun&&this.run(),this.retransmit_sotrage_items())}catch(e){console.error("Magic Links 'init' procedure fail! Details: "+e),e.stack&&console.error(e.stack)}}retransmitlog(e){let t=this._envSettings.events_recording_api+"/log";return fetch(t,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrer:"*client",body:e}).then(t=>{if(t.ok){let i="Write to events-recording service. Body:\n"+e;return this._scriptEm.hasAttribute("data-simulator")&&this._log(i),this._debug(i),t.json()}this._log("Fail to write event data. HTTP error, status = "+t.status)}).then(e=>{e&&e.message&&this._log(e.message)}).catch(e=>{this._log(e)})}retransmit(e){let t=this._envSettings.events_recording_api+"/write";return fetch(t,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrer:"*client",body:e}).then(t=>{if(t.ok){let i="Write to events-recording service. Body:\n"+e;return this._scriptEm.hasAttribute("data-simulator")&&this._log(i),this._debug(i),t.json()}this._log("Fail to write event data. HTTP error, status = "+t.status)}).then(e=>{e&&e.message&&this._log(e.message)}).catch(e=>{this._log(e)})}retransmit_sotrage_items(){if("undefined"!=typeof Storage){let e="";for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(t.startsWith("fr_click_")){let e=localStorage.getItem(t);this.retransmit(e),localStorage.removeItem(t)}else if(t.startsWith("fr_log_")){let e=localStorage.getItem(t);this.retransmitlog(e),localStorage.removeItem(t)}}}}parseQueryString(e){var t={},i,r,n,s;for(n=0,s=(i=e.split("&")).length;n<s;n++)(r=i[n].split("="))[0]=r[0].replace("?",""),t[r[0]]=r[1];return t}ampRedirectNow(){this.targetUrl=null;let e=this.parseQueryString(location.search);if(!e.anchor_href)return;this.targetUrl=e.anchor_href;let t=document.getElementById("fr-link"),i;t.href=decodeURIComponent(this.targetUrl),e.source&&(trx.source=decodeURIComponent(e.source)),e.referrer&&(trx.referrer=decodeURIComponent(e.referrer)),this._prepareSettings(),this._prepareExcludeRegExp(),this.run(),0===this._links.length&&(location.href=t.href),this._collectClickTimeParams(),this._addMetadataFromRequest(e),this._writeDataToEventsService(this._links[0],"AMP").then(()=>{t.setAttribute("data-written","true"),t.click()})}_addMetadataFromRequest(e){if(void 0!==this._settings.features&&void 0!==this._settings.features.metadata){let t=this._settings.features.metadata;if(this._asBoolean(t.enabled)&&!this._isEmpty(t.selectors)){let i,r,n,s=t.selectors.split("\n");for(let t=0;t<s.length;t++)try{let n=s[t];if(this._isEmpty(n))this._log("Ignoring empty line in metadata settings.");else{let t=n.split("|");if(t.length>1){if(i=t[0].trim(),r=t[1].trim(),0===r.length)continue;void 0===e[i]||this._isEmpty(e[i])||(this._paramsBuffer.metadata[i]=e[i])}else this._log("Invalid metadata line. Line must have name and Xpath value in this format: name | xpath ")}}catch(e){this._log(e)}}}}get onPageSettings(){return this._onPageSettings}get serverSettings(){return this._serverSettings.hasOwnProperty("SETTINGS_PLACEHOLDER")?{}:this._serverSettings}get paramsBuffer(){return this._paramsBuffer}static renderLinkPreview(e,t){let i=document.querySelector('iframe[data-ml-preview="'+e+'"]');if(null!=i)return void i.parentNode.removeChild(i);let r=document.querySelector('a[data-ml-id="'+e+'"]');if(null!=r){let t=document.createElement("iframe");t.setAttribute("data-ml-preview",e),t.setAttribute("scrolling","no"),t.setAttribute("frameborder","0"),t.style.borderStyle="solid",t.style.borderWidth="2px",t.style.borderColor="grey",t.style.borderRadius="3px",t.style.position="absolute",t.style.width="120px",t.style.height="90px",t.style.background="#fff";let i=document.documentElement,n=r.getBoundingClientRect();t.style.top=n.top+(window.pageYOffset-i.clientTop)-100+"px",t.style.left=n.left+(window.pageXOffset-i.clientLeft)+(n.width-60)+"px",document.body.appendChild(t);let s=t.contentWindow||t.contentDocument;s.document&&(s=s.document);let a=s.createElement("img"),l="http://images.shrinktheweb.com/xino.php?stwembed=1&stwaccesskeyid=4abc115f8a632c5&stwsize=120x90&stwurl="+r.href;a.setAttribute("src",l),a.style.width="100%",a.style.height="auto",s.body.appendChild(a),s.body.style.padding="1px"}t.stopImmediatePropagation()}run(){try{if(!this._scriptEm.hasAttribute("data-property-id")||!this._scriptEm.hasAttribute("data-customer-id")||this._isEmpty(this._scriptEm.hasAttribute("data-property-id"))||this._isEmpty(this._scriptEm.hasAttribute("data-customer-id")))return void this._error("Missing one of the mandatory script attributes 'data-customer-id' and/or 'data-property-id'");if(this._isEmpty(this._envSettings.events_recording_api))return void this._error("Missing environment settings. Check that you setup $ENV_SETTINGS in my.cfg.php and that 'events_recording_api' is set there!");if(!this._checkPageUrlMatch())return;if(document.links.length>0)for(let e=0;e<document.links.length;e++){let t=document.links[e],i=t.getAttribute("data-orig-url");this._isEmpty(i)||(t.href=i),t.removeAttribute("data-ml-dynamic-type"),t.removeAttribute("data-ml-dynamic"),t.removeAttribute("data-ml-id"),t.removeAttribute("data-xid"),t.removeAttribute("data-ml"),t.hasAttribute("data-skimlinks-tracking")&&t.setAttribute("data-skimlinks-tracking",this._cleanupXid(t.getAttribute("data-skimlinks-tracking")))}this._detectLinks(),this._disbaleLinks(),this._links.length>0&&(this._appendUUID(),this._runFeatures()),this._logPageTrace();for(let e=0;e<this._links.length;e++){let t=this._links[e];t.info.dynamic||t.info.disable||(t.info.embedded?t.anchor.href=t.info.wrapping_url.replace(this._embedUrlToken,encodeURIComponent(t.info.url)):t.anchor.href=t.info.url)}null!=r&&"true"===r.getAttribute("data-report")&&this._postReport(),void 0!==trx.SpotClient&&(trx.spotEngine=new trx.SpotClient(trx.magicLinksEngine),trx.spotEngine.start())}catch(e){this._error("'run' procedure fail! Details: "+e,e.stack)}}registerCustomLinks(e){for(let[t,i]of e)this.registerCustomLink(t,i)}registerCustomLink(e,t){if(this._isEmpty(e)||this._isEmpty(t))this._error("registerCustomLink method was invoked with either empty 'id' or empty 'url' arguments. Check you call to method(s) 'registerCustomLink' / 'registerCustomLinks'");else{let i=document.getElementById(e);null!=i&&i.parentNode.removeChild(i),i=document.createElement("a"),i.href=t,i.id=e,i.style.display="none",i.setAttribute("data-ml-custom-link","true"),i.setAttribute("target","_blank"),document.body.append(i),this._customLinks.set(e,{orig_url:t})}}getProcessedCustomLinks(){for(let[e,t]of this._customLinks){let i=document.getElementById(e);t.processed=i.hasAttribute("data-ml"),t.processed&&(t.fr_url=i.href)}return this._customLinks}recordCustomLinkClick(e,t){try{let i=!1;for(let r=0;r<this._links.length;r++){let n=this._links[r];if(n.anchor.id===e){let e={type:"custom-url"};this._linkClicked(n,e,t),i=!0;break}}i||this._error("recordCustomLinkClick was invoked with unrecognized id: '"+e+"'. The id should be the same as the value used when you invoked registerCustomLink(...) or registerCustomLinks(...)")}catch(e){this._error("Fail to trigger custom link. Details: "+e,e.stack)}}_runFeatures(){if(this._paramsBuffer.origin=this.href,this._paramsBuffer.property_id=this._scriptEm.getAttribute("data-property-id"),this._paramsBuffer.customer_id=this._scriptEm.getAttribute("data-customer-id"),this._paramsBuffer.cidp1=this._paramsBuffer.customer_id,this._paramsBuffer.cidp2="-",-1!==this._paramsBuffer.customer_id.indexOf("_")){const e=this._paramsBuffer.customer_id.split("_");if(e.length>2){let t=e.slice(0,e.length-1);this._paramsBuffer.cidp1=t.join("_"),this._paramsBuffer.cidp2=e[e.length-1]}}this._paramsBuffer.source=location.href,void 0!==trx.source&&(this._paramsBuffer.source=trx.source),this._paramsBuffer.event_type="click",this._paramsBuffer.urls.source=location.href;let e=this._settings.features;for(let t in e)if(e.hasOwnProperty(t)){let i=e[t];if(!this._asBoolean(i.enabled))continue;switch(t){case"append_referrer":this._appendReferrer(i);break;case"append_timing":this._appendTiming(i);break;case"append_attributes":this._appendAttributes(i);break;case"attributes_forwarding":this._attributesForwarding(i);break;case"track_events":this._prepareEventTracking(i);break;case"auto_optimize_link":this._autoOptimizeLinks(i);break;case"link_preview":this._preparePreview(i);break;case"shorten_extra_param":this._prepareShortExtraParam(i);break;case"metadata":this._prepareMetadata(i);break}}for(let e=0;e<this._links.length;e++){let t=this._links[e];if(1==t.info.disable)continue;null!=t.anchor.click_fn&&"function"==typeof t.anchor.click_fn&&t.anchor.removeEventListener("click",t.anchor.click_fn);let i=this._linkClicked.bind(this,t);t.anchor.addEventListener("click",i),t.anchor.click_fn=i,null!=t.anchor.contextmenu_fn&&"function"==typeof t.anchor.contextmenu_fn&&t.anchor.removeEventListener("contextmenu",t.anchor.contextmenu_fn);let r=this._linkClicked.bind(this,t);t.anchor.addEventListener("contextmenu",r),t.anchor.contextmenu_fn=r}this._setSkimDynamicXcust()}_setSkimDynamicXcust(){if(this._asBoolean(this._settings.detection_rules.auto_networks.dynamic))for(let e=0;e<this._links.length;e++){let t=this._links[e];if(t.info.dynamic&&"sl"===t.info.dynamicType){let e=t.anchor.hasAttribute("data-skimlinks-tracking")?t.anchor.getAttribute("data-skimlinks-tracking"):"";e=this._cleanupXid(e),this._isEmpty(e)||(e+="|"),e+="xid:"+t.info.xid,t.anchor.setAttribute("data-skimlinks-tracking",e)}}}_linkClicked(e,t,i){if(e.info.dynamic){let t;if("vg"===e.anchor.getAttribute("data-ml-dynamic-type")){let t=vglnk.opt("cuid");t=this._cleanupXid(t),this._isEmpty(t)||(t+="|"),t+="xid:"+e.info.xid,vglnk.opt("cuid",t)}}this._collectClickTimeParams();let r=!1;void 0!==e.anchor&&(r=e.anchor.getAttribute("data-written"),"true"===r)||this._writeDataToEventsService(e,t.type,i)}_cleanupXid(e,t){if(null==e)return"";let i,r;return null==t&&(t=""),this._isEmpty(e)||(i=e.indexOf("|xid:fr"),r="|xid:fr".length,-1===i&&(i=e.indexOf("xid:fr"),r="xid:fr".length),-1!==i&&(e=this._insertSubstringToString(e,t,i,i+r+16))),e}_appendUUID(){let e={amazon:this._asBoolean(this._settings.detection_rules.amazon_no_append)};for(let t=0;t<this._links.length;t++){let i=this._links[t],r=i.info.url,n=i.network,s=this._generateUUID();i.info.xid=s,null!=e[n]&&!1!==e[n]||(i.info.embedded&&null!=i.info.wrapping_url&&(i.info.wrapping_url=this._appendExtraParam(i.info.wrapping_net,i.info.wrapping_url,"xid",s,!1)),i.info.url=this._appendExtraParam(n,r,"xid",s,!1)),i.anchor.setAttribute("data-xid",s)}}_appendReferrer(e){if(this._asBoolean(e.enabled)){let t=e.attr_name,i=this._asBoolean(e.new_query_param),r=document.referrer;void 0!==trx.referrer&&(r=trx.referrer),"/"===r.charAt(r.length-1)&&(r=r.substring(0,r.length-1)),this._paramsBuffer[t]=r,this._paramsBuffer.urls.referrer=r,this._paramsBuffer.urls.is_trx_referrer=void 0!==trx.referrer}}_appendTiming(e){if(this._asBoolean(e.enabled)){let t=this._asBoolean(e.new_query_param),i;e.t_load&&(this._paramsBuffer.t_loaded=this._loadTime,this._paramsBuffer.timing.t_loaded=this._loadTime)}}_appendAttributes(e){if(this._asBoolean(e.enabled)&&!this._isEmpty(e.attributes)>0){let t;this._parseQuery(e.attributes).forEach((e,t,i)=>{for(let i=0;i<this._links.length;i++){let r=this._links[i];this._paramsBuffer[t]=e,this._paramsBuffer.attr_append[t]=e}})}}_attributesForwarding(e){if(this._asBoolean(e.enabled)&&e.attributes instanceof Array&&e.attributes.length>0){let t=location.search;if(!this._isEmpty(t)&&t.length>1){let i;this._parseQuery(t.substring(1)).forEach((t,i,r)=>{e.attributes.includes(i)&&(this._paramsBuffer[i]=t,this._paramsBuffer.attr_forwarding[i]=t)})}}}_prepareEventTracking(e){if(this._asBoolean(e.enabled)){if(this._isEmpty(e.analytics_code)||0!==e.analytics_code.indexOf("UA-")||"undefined"==typeof ga){if(this._isEmpty(e.analytics_code)||"undefined"==typeof s||"function"!=typeof s.tl)return;this.trackerObj=new trx.AdobeTracker(e.analytics_code)}else this.trackerObj=new trx.GATracker(e.analytics_code);if(this._asBoolean(e.pageview)&&this.trackerObj.trackPageView(),this._asBoolean(e.clicks))for(let t=0;t<this._links.length;t++){let i=this._links[t],r=i.anchor,n=i.info.xid;r.addEventListener("click",()=>{let t=this._getAnchorLabel(r,50)+" ["+r.href+"]";this.trackerObj.trackEvent("magic-links","click",t,"1",{xid:n,anchor:r,props_map:e.props_map,props_map_custom:e.props_map_custom,data:this.paramsBuffer})}),this._markLink("feature","track_events",r)}}}_autoOptimizeLinks(e){this._asBoolean(e.enabled)}_preparePreview(e){if(this._asBoolean(e.enabled)){if(e.show_icon)for(let e=0;e<this._links.length;e++){let t,i=this._links[e].anchor,r=document.createElement("span");r.style.cursor="pointer",r.innerHTML="&nearr;",r.addEventListener("click",trx.MagicLinks.renderLinkPreview.bind(this,i.getAttribute("data-ml-id"))),i.insertAdjacentElement("afterend",r),this._markLink("feature","preview",i)}e.show_metadata,e.show_coupons}}_prepareShortExtraParam(e){this._asBoolean(e.enabled)}_prepareMetadata(e){if(!this._isEmpty(e.selectors)){let t,i,r,n=e.selectors.split("\n");for(let e=0;e<n.length;e++)try{let s=n[e];if(this._isEmpty(s))this._log("Ignoring empty line in metadata settings.");else{let e=s.split("|");if(e.length>1){if(t=e[0].trim(),i=e[1].trim(),0===i.length)continue;if(0===i.indexOf("js::")){let e=i.replace("js::","").trim();r=trx.MagicLinks._getObjectByPath(e),null==r&&("function"==typeof trx.get[t]?r=trx.get[t]():this._log("Missing function trx.get."+t))}else if(0===i.indexOf("ck::")){let e=i.replace("ck::","").trim();this._isEmpty(e)?this._log("Invalid metadata cookie line. Cookie name is missing"):r=this._getCookie(e)}else if(0===i.indexOf("ls::")){let e=i.replace("ls::","").trim();if("undefined"!=typeof Storage){let t=window.localStorage.getItem(e);this._isEmpty(t)?this._log("Invalid metadata localStorage line. Sorage name is missing"):r=t}}else if("function"==typeof document.evaluate){let e;r=document.evaluate(i,document,null,XPathResult.STRING_TYPE,null).stringValue}this._isEmpty(r)||((r instanceof Array||"number"==typeof r)&&(r=r.toString()),this._paramsBuffer[t]=r.trim(),this._paramsBuffer.metadata[t]=r.trim())}else this._log("Invalid metadata line. Line must have name and Xpath value in this format: name | xpath ")}}catch(e){this._log(e)}}}_getCookie(e){let t=e+"=",i,r=decodeURIComponent(document.cookie).split(";");for(let e=0;e<r.length;e++){let i=r[e];for(;" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return""}_logPageTrace(){try{if(sessionStorage){let e=this._needToClearTraces(),t=sessionStorage.getItem("fr_referrer_trace");if(null==t||e)t=[];else try{t=JSON.parse(t)}catch(e){t=[]}let i=sessionStorage.getItem("fr_last_loaded_page"),r;if(null!=i&&i===location.href)return void(this._paramsBuffer.page_trace=t);sessionStorage.setItem("fr_last_loaded_page",location.href),r=t.length>=10?{source:"..."}:{source:location.href,referrer:document.referrer,attr_forwarding:this._paramsBuffer.attr_forwarding},t.push(r),sessionStorage.setItem("fr_referrer_trace",JSON.stringify(t)),this._paramsBuffer.page_trace=t}}catch(e){this._error("Error when recording referrer trace. Details: "+e)}}_needToClearTraces(){if(this._isEmpty(document.referrer))return!0;let e=!1,t="",i=document.referrer.split("/");return!Array.isArray(i)||(t=i[2],""!==t&&t===location.hostname||(e=!0),e)}_disbaleLinks(){if(void 0!==this._settings.disable_rules&&this._asBoolean(this._settings.disable_rules.enabled)&&void 0!==this._settings.disable_rules.networks){var e=[];for(let e=0;e<this._links.length;e++){let t=this._links[e],i=t.info.url,r=t.network;if(this._asBoolean(this._settings.disable_rules.networks[r])&&this._disbaleLink(t),void 0!==this._settings.disable_rules.custom)for(let e of this._settings.disable_rules.custom)switch(e.type){case"url":if(this._isAbsolute(i)&&!this._isEmpty(i)&&!this._isExcludedUrl(i)){let r;new RegExp(e.pattern).test(i)&&this._disbaleLink(t)}break}}}}_disbaleLink(e){e.info.disable=!0;let t=e.anchor.href;e.anchor.setAttribute("data-orig-url",t),e.anchor.href="javascript:void(0)"}_detectLinks(){this._asBoolean(this._settings.detection_rules.auto)&&(this._asBoolean(this._settings.detection_rules.auto_networks.dynamic)&&this._markDynamicDomainLinks(),this._autoDetectByUrl());for(let e of this._settings.detection_rules.custom)switch(e.type){case"url":this._detectByUrlToken(e);break;case"element":this._detectByElementSelector(e);break}for(let e=0;e<this._links.length;e++){let t=this._links[e];t.anchor.setAttribute("data-ml-id",e),t.anchor.setAttribute("data-ml","true")}}_autoDetectByUrl(){let e,t,i=this._settings.detection_rules.auto_networks;for(let r=0;r<document.links.length;r++){let n=document.links[r];if(e=n.href,this._isAbsolute(e)&&!this._isEmpty(e)&&!this._isExcludedUrl(e)){let r={inxStart:0,inxEnd:0,embedded:!1,dynamic:!1,dynamicType:null,url:"",network:""};t=this._detectKnownAffiliateLink(e,r),this._checkEmbeddedLink(e,r),!1!==t&&this._asBoolean(i[t])?(r.network=t,this._links.push({network:t,anchor:n,info:r}),n.hasAttribute("data-orig-url")||n.setAttribute("data-orig-url",e)):!1===t&&this._asBoolean(i.dynamic)&&"true"===n.getAttribute("data-ml-dynamic")&&(r.inxStart=0,r.inxEnd=0,r.embedded=!1,r.dynamic=!0,r.dynamicType=n.getAttribute("data-ml-dynamic-type"),r.url="",r.network=n.getAttribute("data-ml-dynamic-type"),this._links.push({network:t,anchor:n,info:r}),n.hasAttribute("data-orig-url")||n.setAttribute("data-orig-url",e))}}}_detectByUrlToken(e){let t,i;for(let r=0;r<document.links.length;r++){let n=document.links[r];if(t=n.href,this._isAbsolute(t)&&!this._isEmpty(t)&&!this._isExcludedUrl(t)){let r;if(new RegExp(e.pattern).test(t)){let e={inxStart:0,inxEnd:0,embedded:!1,dynamic:!1,dynamicType:null,url:t};i=this._detectKnownAffiliateLink(t,e),!1===i&&(i="other"),this._checkEmbeddedLink(t,e),e.network=i,this._links.push({network:i,anchor:n,info:e}),n.hasAttribute("data-orig-url")||n.setAttribute("data-orig-url",t)}}}}_detectByElementSelector(e){let t,i,r;document.querySelectorAll(e.selector).forEach(r=>{if("A"===r.nodeName&&(t=r.href,this._isAbsolute(t)&&!this._isEmpty(t)&&!this._isExcludedUrl(t))){let n;if(new RegExp(e.pattern).test(t)){let e={inxStart:0,inxEnd:0,embedded:!1,dynamic:!1,dynamicType:null,url:t};i=this._detectKnownAffiliateLink(t,e),!1===i&&(i="other"),this._checkEmbeddedLink(t,e),e.network=i,this._links.push({network:i,anchor:r,info:e}),r.hasAttribute("data-orig-url")||r.setAttribute("data-orig-url",t)}}})}_detectKnownAffiliateLink(e,t){let i,r,n={};void 0!==this._serverSettings.impact_domains&&(n=this._serverSettings.impact_domains);var s=e.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i),a=s&&s[1];if(null!==a&&1!==n[a]){const e=/(([a-z\-0-9]+)(?:\.com|\.fr|\.co.uk|\.io|\.net|\.com.au|\.co))/g;null!==(s=a.match(e))&&1==s.length&&(a=s[0])}if(-1!==e.indexOf("/dp/")&&e.includes("tag=")&&(r=-1!==e.indexOf("amazon."))||(r=-1!=e.indexOf("/amzn."))||(r=-1!=e.indexOf("/www.amzn."))||(r=-1!=e.indexOf(".amazon-adsystem.com")))i="amazon";else if(-1!==(r=e.indexOf("linksynergy")))i="ls";else if(-1!==(r=e.indexOf("anrdoezrs.net"))||-1!==(r=e.indexOf("jdoqocy.com"))||-1!==(r=e.indexOf("tqlkg.com"))||-1!==(r=e.indexOf("tkqlhce.com"))||-1!==(r=e.indexOf("dpbolvw.net"))||-1!==(r=e.indexOf("jqoqocy.com"))||-1!==(r=e.indexOf("kqzfj.com"))||-1!==(r=e.indexOf("kqzyfj.com"))||-1!==(r=e.indexOf("ftjcfx.com"))||-1!==(r=e.indexOf("lduhtrp.net")))i="cj";else if(-1!==(r=e.indexOf("shareasale.com")))i="sas";else if(-1!==(r=e.indexOf("awin1.com")))i="awin";else if(-1!==(r=e.indexOf("pepperjamnetwork.com"))||-1!==(r=e.indexOf("pjtra.com/t/"))||-1!==(r=e.indexOf("gopjn.com/t/"))||-1!==(r=e.indexOf("pjatr.com/t/"))||-1!==(r=e.indexOf("pntra.com/t/"))||-1!==(r=e.indexOf("pntrs.com/t/"))||-1!==(r=e.indexOf("pntrac.com/t/")))i="pj";else if(-1!==(r=e.indexOf("track.webgains.com")))i="wg";else if(-1!==(r=e.indexOf("prf.hn/click")))i="pt";else if(-1!==(r=e.indexOf("tradedoubler.com/click?"))||-1!==(r=e.indexOf("pf.tradedoubler.com/pf/")))i="td";else if(-1!==(r=e.search(/\/c\/(\d+)\/(\d+)\//))||-1!==(r=e.search(/%2F(\d+)%2F(\d+)%2F/))||1==n[a])i="ir";else if(-1!==(r=e.indexOf("go.redirectingat.com"))||-1!==e.indexOf("go.skimresources.com")||-1!==e.indexOf("fave.co"))i="sl";else if(-1!==(r=e.indexOf("redirect.viglink.com")))i="vg";else if(-1!==(r=e.indexOf("avantlink.com/click")))i="al";else if(-1!==(r=e.indexOf("track.adtraction.com"))||-1!==(r=e.indexOf("adtr.co")))i="at";else{if(-1===(r=e.indexOf("tc.tradetracker.net")))return!1;i="tt"}return t.inxNext=r,i}_findAsin(e){let t=null;const i=/(?:[/dp/]|$)([A-Z0-9]{10})/g,r=e.match(i);return null!==r&&1===r.length&&(t=r[0].replace("/","")),t}_checkEmbeddedLink(e,t){let i=t.inxNext,r=e.lastIndexOf("=",i);if(-1!==r&&r<i){t.inxStart=r+1;let n=e.indexOf("&",i);-1===n&&(n=e.length),t.inxEnd=n,t.embedded=!0,t.url=decodeURIComponent(e.substring(t.inxStart,t.inxEnd));let s=e.substring(0,t.inxStart),a=e.substring(t.inxEnd);t.wrapping_url=s+this._embedUrlToken+a,-1!==e.indexOf("go.redirectingat.com")||-1!==e.indexOf("go.skimresources.com")?t.wrapping_net="sl":-1!==e.indexOf("redirect.viglink.com")&&(t.wrapping_net="vg")}else t.inxStart=0,t.inxEnd=e.length,t.embedded=!1,t.url=e}_markDynamicDomainLinks(){let e,t;if("undefined"!=typeof __SKIM_JS_GLOBAL__&&"function"==typeof __SKIM_JS_GLOBAL__.getDebugInfo)e="sl",t=__SKIM_JS_GLOBAL__.getDebugInfo().runTimeInfo.aff_domains;else{if("undefined"==typeof vglnk||"function"!=typeof vglnk.opt)return;e="vg",t=vglnk.opt("commercial_domains")}if(null!=t){for(let i=0;i<document.links.length;i++)try{let r=document.links[i],n=r.hostname;n=n.replace("www.",""),!0===t[n]&&(r.setAttribute("data-ml-dynamic","true"),r.setAttribute("data-ml-dynamic-type",e))}catch(e){this._log(e)}try{this._debug("FR find dynamic domains: "+JSON.stringify(t))}catch(e){}}else this._debug("FR didn't find dynamic domains")}_isExcludedUrl(e){let t=this._exclude_urls_regex;for(let i=0;i<t.length;i++)if(t[i].test(e))return!0;return!1}_prepareSettings(){this._settings=trx.MagicLinks.prepareDefaultSettings({}),Object.keys(this.serverSettings).length>0&&(this._settings=this._extendForte(this._settings,this.serverSettings)),Object.keys(this.onPageSettings).length>0&&(this._settings=this._extendForte(this._settings,this.onPageSettings))}_collectClickTimeParams(){let e=this._settings.features.append_timing;if(this._asBoolean(e.enabled)){let t=e.t_clicked,i=e.t_toclick,r=Date.now();t&&(this._paramsBuffer.t_clicked=r,this._paramsBuffer.timing.t_clicked=r),i&&(this._paramsBuffer.t_toclick=r-this._loadTime,this._paramsBuffer.timing.t_toclick=r-this._loadTime)}}_writeDataToEventsService(e,t,i){let r;try{r=JSON.parse(JSON.stringify(this._paramsBuffer))}catch(e){r=this._paramsBuffer}r.uuid=e.info.xid;var n=e.info.xid;if(r.link_replaced=!1,e.anchor.hasAttribute("data-spot-rid")){let t=e.anchor.getAttribute("data-spot-rid"),i=e.anchor.getAttribute("data-orig-url"),s=e.anchor.getAttribute("data-spot-replaced");n=t,r.uuid=t,r.original_xid=e.info.xid,r.link_replaced=!0,r.orig_url=i,r.link_replace_to=s}if(r.client_time=(new Date).toISOString(),r.anchor_id=this._emptyIfNull(e.anchor.id),r.anchor_href=e.anchor.href,r.anchor_label=e.anchor.innerText,r.page_title=document.title,r.spot_id="",r.network=e.info.network,null!=t&&(r.event_type=t),null!=i&&"object"==typeof i)for(let e in i)i.hasOwnProperty(e)&&0===e.indexOf("custom_")&&(r[e]=i[e]);let s=this._envSettings.events_recording_api+"/write",a={env:this._envSettings.events_recording_env,id:n,app_key:this._envSettings.app_key,property_id:r.property_id,customer_id:r.customer_id,cidp1:r.cidp1,cidp2:r.cidp2,event_type:r.event_type,network:r.network,data:encodeURIComponent(JSON.stringify(r))},l=JSON.stringify(a),o=JSON.parse(l);o.data=r;let d=JSON.stringify(o),c=r.uuid;if(delete r.uuid,delete r.client_time,delete r.anchor_href,delete r.anchor_label,delete r.page_title,delete r.spot_id,"undefined"!=typeof Storage){var u="fr_click_"+c;localStorage.setItem(u,l)}if(void 0!==this._envSettings.events_recording_api2){let e=this._envSettings.events_recording_api2+"/write";fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrer:"*client",body:l}).then(e=>{if(e.ok){let t="Write to events-recording service. Body:\n"+d;return this._scriptEm.hasAttribute("data-simulator")&&this._log(t),this._debug(t),e.json()}if(this._log("Fail to write event data. HTTP error, status = "+e.status),"undefined"!=typeof Storage){var t=Math.round((new Date).getTime()/1e3);u="fr_log_"+t}}).then(e=>{e&&e.message&&this._log(e.message)}).catch(e=>{this._log(e)})}return fetch(s,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrer:"*client",body:l}).then(e=>{if(e.ok){let t="Write to events-recording service. Body:\n"+d;return this._scriptEm.hasAttribute("data-simulator")&&this._log(t),200==e.status&&"undefined"!=typeof Storage&&localStorage.removeItem(u),this._debug(t),e.json()}if(this._log("Fail to write event data. HTTP error, status = "+e.status),"undefined"!=typeof Storage){var t=Math.round((new Date).getTime()/1e3);u="fr_log_"+t;var i=this._getLogInfomration(r);i.message="Fail to write event data. HTTP error, status = "+e.status,localStorage.setItem(u,JSON.stringify(i))}}).then(e=>{if(e&&e.message&&(this._log(e.message),"undefined"!=typeof Storage)){var t=Math.round((new Date).getTime()/1e3);u="fr_log_"+t;var i=this._getLogInfomration(r);i.message=e.message,localStorage.setItem(u,JSON.stringify(i))}}).catch(e=>{if(this._log(e),"undefined"!=typeof Storage){var t=Math.round((new Date).getTime()/1e3);u="fr_log_"+t;var i=this._getLogInfomration(r);i.message=e.message,localStorage.setItem(u,JSON.stringify(i))}})}_getLogInfomration(e){return e.env=this._envSettings.events_recording_env,e.app_key=this._envSettings.app_key,e.loginfo={nAgt:navigator.userAgent,screen:screen.width+"*"+screen.height},e}_log(e){console.log(this._logPrefix+e)}_error(e,t){console.error(this._logPrefix+e),null!=t&&console.error(t)}_debug(e){null!=window.trxdebug&&console.log(this._logPrefix+e)}_prepareExcludeRegExp(){this._exclude_urls_regex=[];let e=this._settings.detection_rules.exclude_urls;if(e.length>0)for(let t=0;t<e.length;t++)this._exclude_urls_regex.push(new RegExp(e[t],"i"))}_extendForte(e,t){if(null==e||null==t)throw"Null object provided to extendForte!";const i={};let r;for(r in e)if(e.hasOwnProperty(r)){let n=e[r];const s=t[r];i[r]=null!=n&&null!=s?n instanceof Array?s:"object"==typeof n?this._extendForte(n,s):s:null==n?s:null==s?n:null}for(r in t)t.hasOwnProperty(r)&&(r in e&&null!=e[r]||(i[r]=t[r]));return i}_postReport(){this._report={links:[]};for(let e=0;e<this._links.length;e++){let t=this._links[e].anchor,i=this._getAnchorLabel(t,100);this._report.links.push({network:this._links[e].network,url:t.href,label:i})}window.postMessage({type:"MSG_FROM_MAGIC_LINKS",action:"report",report:JSON.stringify(this._report)},"*")}_markLink(e,t,i){let r=i.getAttribute("data-"+e);r+=","+t,i.setAttribute("data-"+e,r)}_appendExtraParam(e,t,i,r,n){let s=null,a=!1;var l=":";if(n)s=null;else switch(e){case"cj":s="sid",a=!0,l="%40%25";break;case"ls":s="u1";break;case"sas":s="afftrack";break;case"awin":s="clickref";break;case"pj":s="sid";break;case"sl":s="xcust";break;case"vg":s="cuid";break;case"ir":s="subId3";break;case"wg":s="clickref";break;case"td":s="epi(",a=!0;break;case"pt":s="pubref:",a=!0;break;case"amazon":s="ascsubtag";break;case"al":s="ctc";break;case"at":s="epi";break;case"tt":s="r";break;default:s=null}return this._appendNameValueToUrl(t,i,r,s,a,e,l)}_appendNameValueToUrl(e,t,i,r,n,s,a){let l,o,d,c,u,h;return i=encodeURIComponent(i),void 0===a&&(a=":"),null!=r?(u=t+a+i,n?(l=e.indexOf(r+"/"),-1!==l?(l+=(r+"/").length,o=e.indexOf("/",l),-1===o&&(o=e.length),h=e.substring(l,o),h.length>0&&(u=this._getDelimiter(e)+u),this._insertToString(e,u,o)):"pt"===s?this._appendNameValueToUrl_PT(e,t,i,r,u):"cj"===s?this._appendNameValueToUrl_CJ(e,t,i,r,u):"td"===s?this._appendNameValueToUrl_TD(e,t,i,r,u):(u="/"+r+"/"+u,this._insertToString(e,u,e.length))):(l=e.toLocaleLowerCase().indexOf(r.toLocaleLowerCase()+"="),-1===l?(u=-1!==e.indexOf("?")?"&"+r+"="+u:"?"+r+"="+u,this._insertToString(e,u,e.length)):(o=e.indexOf("&",l),-1===o&&(o=e.length),h=e.substring(l+r.length+1,o),h.length>0&&(u=this._getDelimiter(e)+u),this._insertToString(e,u,o)))):(n?e+=t+"/"+i:-1!==e.indexOf("?")?e+="&"+t+"="+i:e+="?"+t+"="+i,e)}_appendNameValueToUrl_TD(e,t,i,r,n){let s,a,l,o,d;return s=e.indexOf("epi("),-1===s?(s=e.indexOf("url("),-1!==s?e+"epi("+n+")":(l=e.indexOf("&epi="),-1===l?e+"&epi="+n:(o=e.indexOf("&",l+5),-1===o?e+this._getDelimiter(e)+n:(n=this._getDelimiter(e)+n,this._insertToString(e,n,o))))):(s+=r.length,a=e.indexOf(")",s),-1!==a?(d=e.substring(s,a),d.length>0&&(n=this._getDelimiter(e)+n),this._insertToString(e,n,a)):e)}_appendNameValueToUrl_PT(e,t,i,r,n){let s,a,l;if(s=e.indexOf(r),-1!==s){if(s+=r.length,a=e.indexOf("/",s),-1!==a)return l=e.substring(s,a),l.length>0&&(n=this._getDelimiter(e)+n),this._insertToString(e,n,a)}else if(s=e.indexOf("/destination"),-1!==s)return n="/pubref:"+n,this._insertToString(e,n,s);return e}_appendNameValueToUrl_CJ(e,t,i,r,n){let s=e.indexOf("dlg/");if(-1===s&&(s=e.indexOf("/am/")),console.log("queryParamToUse"),n=n.replace(":","%40%25"),-1!==s)return n=r+"/"+n+"/",this._insertToString(e,n,s+4);if(-1===e.indexOf("?"))return e+"?sid="+n;{let t=e.indexOf("?"),i=e.indexOf("sid=",t+1);if(-1===i&&(i=e.indexOf("&sid=",t+1)),-1!==i){let t=e.indexOf("&",i+5);return-1===t?e+this._getDelimiter(e).replace("|",this._delimiter3)+n:(n=this._getDelimiter(e).replace("|",this._delimiter3)+n,this._insertToString(e,n,t))}return t===e.length-1?e+"sid="+n:e+"&sid="+n}}_checkPageUrlMatch(){return!!this._isEmpty(this._settings.detection_rules.page_url_filter)||location.href.includes(this._settings.detection_rules.page_url_filter)}_insertToString(e,t,i){let r,n;return r=e.substring(0,i),n=i<e.length?e.substring(i):"",r+t+n}_insertSubstringToString(e,t,i,r){let n,s;return n=e.substring(0,i),s=e.substring(r),n+t+s}_parseQuery(e){let t=new Map;if(!e)return t;const i=e.split(/[;&]/);for(let e=0;e<i.length;e++){let r=i[e].split("=");if(!r||2!==r.length)continue;const n=unescape(r[0]);let s=unescape(r[1]);s=s.replace(/\+/g," "),t.set(n,s)}return t}_getAnchorLabel(e,t){let i=document.createElement("label");i.innerHTML=e.innerHTML,i.normalize();let r=i.innerHTML;return r=r.trim(),r.length>t&&(r=r.substring(0,t)+"..."),r}_isEmpty(e){return null==e||""===e}_emptyIfNull(e){return null==e?"":e}_isAbsolute(e){return 0===e.indexOf("http://")||0===e.indexOf("https://")}_asBoolean(e){return"true"===e||!0===e}_generateUUID(){const e=Date.now(),t=String.fromCharCode(Math.floor(10*Math.random()+97)),i=String.fromCharCode(Math.floor(10*Math.random()+97)),r=String.fromCharCode(Math.floor(10*Math.random()+97));return`fr${e}${t}${i}${r}`}static _getObjectByPath(e,t){null==t&&(t=window);const i=e.split(".");if(1===i.length)return t[i[0]];{let e=t;for(let t=0;t<i.length;t++){const r=i[t];if("window"!==r&&(e=e[r],null==e&&t<i.length-1))return null}return e}}_getDelimiter(e){return e.includes("assoc-redirect.amazon")?this._delimiter2:e.includes("anrdoezrs.net")?this._delimiter3:this._delimiter1}_runFRCallback(){try{null!=window.funnelRelayReady&&"function"==typeof window.funnelRelayReady&&window.funnelRelayReady()}catch(e){this._error("Fail to run callback function 'funnelRelayReady'. Details: "+e)}}},trx.get={};trx.get.PageUniqueID = function(){return eval("mdManager.getParameter(\'UniqueID\')");};trx.get.PageTitle = function(){return eval("mdManager.getParameter(\'Title\')");};trx.get.PublicationDate = function(){return eval("mdManager.getParameter(\'OrigPubDate\')");};trx.get.PageType = function(){return eval("mdManager.getParameter(\'Type\')");};trx.get.CategoryDspName = function(){return eval("mdManager.getParameter(\'CategoryDspName\')");};trx.get.PageName = function(){return eval("mdManager.getParameter(\'Url\')");};trx.get.Tags = function(){return eval("var tt=\'\';document.getElementsByClassName(\'o-Tags\')[0].querySelectorAll(\'a.a-Tag\').forEach(function(node) {tt+=node.innerHTML+\',\';});tt.substring(0, tt.length - 1);");},trx.GATracker=class{constructor(e){this.gaCode=e,window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create",this.gaCode,"auto","mlTracker",{alwaysSendReferrer:!0,allowAnchor:!1}),ga("mlTracker.set","referrer",document.referrer),ga("mlTracker.set","appName","trackonomics-relay")}trackEvent(e,t,i,r,n){ga((function(s){ga("mlTracker.send","event",{eventCategory:e,eventAction:t,eventLabel:i,eventValue:r,fieldsObject:n,transport:"beacon"})}))}trackScreenView(e){ga((function(t){ga("mlTracker.send","screenview",{screenName:e,appId:this.appId,appVersion:this.appVersion,appName:this.appName})}))}trackPageView(){ga((function(e){ga("mlTracker.set","page",location.href),ga("mlTracker.send","pageview",{page:location.href,title:document.title})}))}},trx.AdobeTracker=class{constructor(e){null!=e&&e.length>0?this._rsId=e:this._rsId=null}trackEvent(e,t,i,r,n){if("function"==typeof s.tl){let e=s,t=null!=this._rsId?this._rsId:s_account;null!=t&&(e=s_gi(t));let i=n.props_map;null==i&&(i={xid:"prop1",link:"prop2",label:"prop3",referrer:"prop4",origin:"prop5"});let r=n.props_map_custom,a=[i.xid,i.link,i.label,i.referrer,i.origin];if(null!=r)for(let e=0;e<r.length;e++){let t=r[e];a.push(t.prop)}if(e.linkTrackVars=a.join(","),e[i.xid]=n.xid,e[i.link]=n.anchor.href,e[i.label]=n.anchor.innerHTML,e[i.referrer]=document.referrer,e[i.origin]=location.href,null!=r)for(let t=0;t<r.length;t++){let i=r[t];e[i.prop]=trx.MagicLinks._getObjectByPath(i.field,n.data)}e.linkTrackEvents="funnel-relay",e.events="funnel-relay";let l="funnel-relay-"+n.xid;e.tl(!0,"o",l,null)}}trackScreenView(e){}trackPageView(){}};let e=void 0,t="prod",i=!0,r=document.getElementById("funnel-relay-installer");null!=r&&r.hasAttribute("data-autorun")&&(i="false"!==r.getAttribute("data-autorun"));let n=3e3,a="{START_DELAY}",l=parseInt("{START_DELAY}");Number.isInteger(l)&&(n=l),n>0?setTimeout(()=>{trx.magicLinksEngine=new trx.MagicLinks(i),trx.magicLinksEngine._runFRCallback()},n):(trx.magicLinksEngine=new trx.MagicLinks(i),trx.magicLinksEngine._runFRCallback())}();